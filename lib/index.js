"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.HttpBuilder=void 0;var _client=require("./client"),_isFunction2=_interopRequireDefault(require("lodash/isFunction"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_unsupportedIterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _iterableToArray(a){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a))return _arrayLikeToArray(a)}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}function _typeof(a){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}var isAFailedHttpResponse=function(a){return a===void 0||!/2[0-9][0-9]/.test(a.status||a.response&&a.response.status)},noop=function(){},methodInvalid=function(a){return null===a||!Object.values(_client.HttpMethods).includes(a)},strategiesInvalid=function(a){return!a.every(_isFunction2["default"])},unauthorized=function(a){return /401/.test(a&&(a.status||a.response&&a.response.status))},noContent=function(a){return /204/.test(a.status)},warnAndInvalidate=function(a){return console.warn(a),!1},validConfiguration=function(a){var b=a.method,c=a.url,d=a.headers,e=a.bearer,f=a.queryParams,g=a.maxRetry,h=a.retryFallbackStrategy,i=a.unauthorizedStrategy,j=a.failedStrategy,k=a.noContentStrategy,l=a.successStrategy,m=a.failedSideEffects,n=a.successSideEffects,o=a.refreshTokenStrategy;if(methodInvalid(b))return warnAndInvalidate("Http method not defined or is invalid");if(!c)return warnAndInvalidate("No url configured");if("object"!==_typeof(d))return warnAndInvalidate("Headers must be an object");if("object"!==_typeof(f))return warnAndInvalidate("Parameters must be an object");if("number"!=typeof g)return warnAndInvalidate("Max retries must be a number");var p=[h,i,j,k,l].concat(_toConsumableArray(m),_toConsumableArray(n),[o]);return!strategiesInvalid(p)||warnAndInvalidate("Strategies must be functions")},call=/*#__PURE__*/function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(b){var c,d,e,f,g=arguments;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(c=1<g.length&&void 0!==g[1]?g[1]:0,d=new _client.HttpRequest({url:b.url,body:b.body,headers:b.headers,queryParams:b.queryParams,responseType:b.responseType}),!(c>=b.maxRetry)){a.next=7;break}return b.retryFallbackSideEffects.forEach(function(a){return a(d)}),a.next=6,b.retryFallbackStrategy(d);case 6:return a.abrupt("return",a.sent);case 7:return b.bearer&&d.addHeader("Authorization","Bearer ".concat(b.bearer)),a.next=10,_client.HttpClient[b.method](d);case 10:if(e=a.sent,!unauthorized(e)){a.next=26;break}return a.next=14,b.refreshTokenStrategy();case 14:if(!a.sent){a.next=20;break}return a.next=17,call(b,c+1);case 17:return a.abrupt("return",a.sent);case 20:return b.unauthorizedSideEffects.forEach(function(a){return a(e)}),a.next=23,b.unauthorizedStrategy(e);case 23:return a.abrupt("return",a.sent);case 24:a.next=31;break;case 26:if(!isAFailedHttpResponse(e)){a.next=31;break}return b.failedSideEffects.forEach(function(a){return a(e)}),a.next=30,b.failedStrategy(e);case 30:return a.abrupt("return",a.sent);case 31:return b.successSideEffects.forEach(function(a){return a(e)}),f=noContent(e)?b.noContentStrategy:b.successStrategy,a.next=35,f(e);case 35:return a.abrupt("return",a.sent);case 36:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),HttpBuilder=/*#__PURE__*/function(){function a(){_classCallCheck(this,a),this.method=null,this.url=null,this.bearer=null,this.headers={},this.queryParams=null,this.responseType=null,this.body=null,this.maxRetry=2,this.retryFallbackStrategy=noop,this.unauthorizedStrategy=noop,this.failedStrategy=function(){return!1},this.noContentStrategy=function(){return!0},this.successStrategy=function(a){return a.data},this.retryFallbackSideEffects=[],this.unauthorizedSideEffects=[],this.failedSideEffects=[],this.successSideEffects=[],this.refreshTokenStrategy=function(){return!1}}// CONFIGURE METHOD
return _createClass(a,[{key:"asGet",value:function asGet(){return this.method=_client.HttpMethods.GET,this}},{key:"asPost",value:function asPost(){return this.method=_client.HttpMethods.POST,this}},{key:"asPut",value:function asPut(){return this.method=_client.HttpMethods.PUT,this}},{key:"asDelete",value:function asDelete(){return this.method=_client.HttpMethods.DELETE,this}// CONFIGURE URL
},{key:"withUrl",value:function withUrl(a){return this.url=a,this}// CONFIGURE HEADERS
},{key:"withAuthorization",value:function withAuthorization(a){return this.bearer=a,this}},{key:"withHeaders",value:function withHeaders(a){return this.headers=a,this}// CONFIGURE PARAMS
},{key:"withParams",value:function withParams(a){return this.queryParams=a,this}// CONFIGURE RESPONSE TYPE
},{key:"withResponseType",value:function withResponseType(a){return this.responseType=a,this}// CONFIGURE BODY
},{key:"withBody",value:function withBody(a){return this.body=a,this}// RETRY
},{key:"withMaxRetries",value:function withMaxRetries(a){this.maxRetry=a}// CONFIGURE STRATEGIES
},{key:"withRetryFallbackStrategy",value:function withRetryFallbackStrategy(a){return this.retryFallbackStrategy=a,this}},{key:"withUnauthorizedStrategy",value:function withUnauthorizedStrategy(a){return this.unauthorizedStrategy=a,this}},{key:"withFailedStrategy",value:function withFailedStrategy(a){return this.failedStrategy=a,this}},{key:"withNoContentStrategy",value:function withNoContentStrategy(a){return this.noContentStrategy=a,this}},{key:"withSuccessStrategy",value:function withSuccessStrategy(a){return this.successStrategy=a,this}// CONFIGURE SIDE EFFECTS
},{key:"withRetryFallbackSideEffects",value:function withRetryFallbackSideEffects(a){return this.retryFallbackSideEffects.push(a),this}},{key:"withUnauthorizedSideEffects",value:function withUnauthorizedSideEffects(a){return this.unauthorizedSideEffects.push(a),this}},{key:"withFailedSideEffect",value:function withFailedSideEffect(a){return this.failedSideEffects.push(a),this}},{key:"withSuccessSideEffect",value:function withSuccessSideEffect(a){return this.successSideEffects.push(a),this}// TO BE CALLED WHEN IN NEED OF A TOKEN REFRESH
// (should return a bool)
},{key:"withRefreshTokenStrategy",value:function withRefreshTokenStrategy(a){return this.refreshTokenStrategy=a,this}// VALIDATE CONFIGURATION AND PERFORM REQUEST
},{key:"send",value:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(){var b;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(b={method:this.method,url:this.url,headers:this.headers,bearer:this.bearer,queryParams:this.queryParams,responseType:this.responseType,body:this.body,maxRetry:this.maxRetry,retryFallbackStrategy:this.retryFallbackStrategy,unauthorizedStrategy:this.unauthorizedStrategy,failedStrategy:this.failedStrategy,noContentStrategy:this.noContentStrategy,successStrategy:this.successStrategy,refreshTokenStrategy:this.refreshTokenStrategy,failedSideEffects:this.failedSideEffects,successSideEffects:this.successSideEffects,unauthorizedSideEffects:this.unauthorizedSideEffects,retryFallbackSideEffects:this.retryFallbackSideEffects},!validConfiguration(b)){a.next=5;break}return a.next=4,call(b);case 4:return a.abrupt("return",a.sent);case 5:case"end":return a.stop();}},a,this)}));return function send(){return a.apply(this,arguments)}}()}]),a}();exports.HttpBuilder=HttpBuilder;